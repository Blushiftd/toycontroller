<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ToyController</title>

<style>
body {
  background: #111;
  color: #eee;
  font-family: sans-serif;
  text-align: center;
  margin: 20px;
}

h2 {
  font-size: 38px;
  margin-bottom: 20px;
}

h3 {
  font-size: 30px;
  margin-bottom: 10px;
}

button {
  font-size: 28px;
  padding: 22px;
  margin: 15px;
  width: 95%;
  border-radius: 14px;
  border: none;
  background: #333;
  color: white;
}

button:active {
  background: #555;
}

.stop {
  background: #800;
}

input[type=range] {
  width: 95%;
  height: 55px;
}

.value-display {
  font-size: 30px;
  margin-top: 10px;
}

.timer-box {
  font-size: 28px;
  padding: 15px;
  width: 130px;
  text-align: center;
  background: #222;
  color: white;
  border: 1px solid #444;
  border-radius: 10px;
}

.section {
  margin: 40px 0;
}

hr {
  border: 1px solid #333;
  margin: 40px 0;
}
</style>
</head>

<body>

<h2>ToyController</h2>

<button onclick="connectBLE()">CONNECT</button>

<hr>

<div class="section">
  <h3>Rotation</h3>
  <input type="range" min="0" max="100" value="50" id="rotSlider">
  <div class="value-display" id="rotValue">50%</div>
</div>

<div class="section">
  <h3>Vibration</h3>
  <input type="range" min="0" max="100" value="50" id="vibSlider">
  <div class="value-display" id="vibValue">50%</div>
</div>

<div class="section">
  <h3>Suction Speed</h3>
  <input type="range" min="0" max="100" value="50" id="sucSlider">
  <div class="value-display" id="sucValue">50%</div>
</div>

<hr>

<div class="section">
  <h3>Suction Cycle Timer</h3>

  <div>ON Time (sec)</div>
  <input class="timer-box" type="number" id="onTime" value="10"><br><br>

  <div>OFF Time (sec)</div>
  <input class="timer-box" type="number" id="offTime" value="5"><br><br>

  <button onclick="startSuction()">START SUCTION CYCLE</button>
</div>

<button onclick="stopAll()" class="stop">STOP ALL</button>

<script>

let device;
let characteristic;
let suctionRunning = false;

const serviceUUID = "00001234-0000-1000-8000-00805f9b34fb";
const charUUID = "00005678-0000-1000-8000-00805f9b34fb";

async function connectBLE() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ToyController" }],
      optionalServices: [serviceUUID]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(serviceUUID);
    characteristic = await service.getCharacteristic(charUUID);

    alert("Connected!");

  } catch (error) {
    alert("Connection failed: " + error);
  }
}

async function sendCommand(cmd) {
  if (!characteristic) return;

  const encoder = new TextEncoder();
  await characteristic.writeValue(encoder.encode(cmd));
}

// ===== Rotation Slider =====

const rotSlider = document.getElementById("rotSlider");
rotSlider.oninput = function() {
  document.getElementById("rotValue").innerText = this.value + "%";
  sendCommand("R" + this.value);
};

// ===== Vibration Slider =====

const vibSlider = document.getElementById("vibSlider");
vibSlider.oninput = function() {
  document.getElementById("vibValue").innerText = this.value + "%";
  sendCommand("V" + this.value);
};

// ===== Suction Slider =====

const sucSlider = document.getElementById("sucSlider");
sucSlider.oninput = function() {
  document.getElementById("sucValue").innerText = this.value + "%";
};

// ===== Suction Cycle Logic =====

function startSuction() {

  if (!characteristic) {
    alert("Not connected");
    return;
  }

  suctionRunning = true;
  runCycle();
}

function runCycle() {

  if (!suctionRunning) return;

  const onSec = parseInt(document.getElementById("onTime").value);
  const offSec = parseInt(document.getElementById("offTime").value);
  const speed = sucSlider.value;

  // Turn suction ON (fires solenoid)
  sendCommand("S" + speed);

  setTimeout(() => {

    if (!suctionRunning) return;

    // Turn suction OFF (releases solenoid)
    sendCommand("S0");

    setTimeout(() => {
      runCycle();
    }, offSec * 1000);

  }, onSec * 1000);
}

function stopAll() {
  suctionRunning = false;
  sendCommand("X0");
}

</script>

</body>
</html>
